/** 
* @author Dominik Kressler
* @version 2.4.0
* @date 2021-11-12
* @description control scripts and iframes that cause in gdpr related problems
* @dependencies notifications.js@1.1.0, J@1.0.0
**/
function PrivacyControl(e){if(_this=this,!e)return _this;if(void 0!==window.pCinit)return alert("*** PricacyControl Error! ***\n\nPlease don't call PrivacyControl twice!\nPrivacyControl bitte nicht doppelt aufrufen!"),!1;
/**
     * internal helper to merge the given deps object to the defaults
     * the function removes deps from obj1 which are set to false in obj2  
     */window.pCinit=!0;var t={deps:!1,sessionName:"privacyCtrl",force:!1,badge:!0,placeholder:"/privacyControl-2.0.placeholder.html",legal_page:{de:"/impressum.php",en:"/legal-notice.php"},privacy_page:{de:"/datenschutzerklaerung.php",en:"/privacy-policy.php"},storage:localStorage},i=[];if(_this.options={},_this.options=J.merge(t,e),_this.frames=[],_this.storage=t.storage||localStorage,_this.options.deps=function(e,t){for(var i in t)!1===t[i]&&delete e[i];return e}(_this.options.deps,e.deps),!1===_this.options.deps||0===Object.entries(_this.options.deps).length)return _this;var n=document.documentElement.lang.split("_")[0].toLowerCase();n=document.documentElement.lang.split("-")[0].toLowerCase(),_this.lang=void 0===_this.options.lang?n:_this.options.lang,void 0===pCl10n[_this.lang]&&(_this.lang="en");var o=function(){for(var e in _this.options.deps)"boolean"==typeof _this.options.deps[e]&&void 0!==pCServiceTemplates[e]?_this.options.deps[e]=pCServiceTemplates[e]:"object"==typeof _this.options.deps[e]&&void 0!==pCServiceTemplates[e]&&(_this.options.deps[e]=J.merge(pCServiceTemplates[e],_this.options.deps[e]));return _this},s=function(e,t){var i="";try{void 0!==t&&void 0!==_this.options.deps[t].l10n[_this.lang][e]?i=_this.options.deps[t].l10n[_this.lang][e]:"object"==typeof _this.options[e]&&void 0!==_this.options[e][_this.lang]?i=_this.options[e][_this.lang]:void 0!==pCl10n[_this.lang][e]&&(i=pCl10n[_this.lang][e])}catch(t){console.log("Translation string missing for: "+e)}return i},r=function(){_this.container=c("privacy-controller"),_this.container.id="privacy-controller";var e=c("privacy-header",_this.container);e.id="privacy-header",c("privacy-text",e).innerHTML=s("intro");var t=c("privacy-buttons",e),i=c("privacy-btn",t);i.id="privacy-open",i.setAttribute("href","#privacyController"),i.innerHTML=s("settings");var n=c("privacy-btn",t);n.id="privacy-confirm",n.setAttribute("href","#privacy-confirm"),n.innerHTML=s("confirm");var o=c("privacy-fields");o.id="privacy-fields";var r=_this.options.deps;for(var l in r)try{var d=document.createElement("input");d.type="checkbox",d.setAttribute("name",l);var p=_this.options.sessionName+":"+l,h=c("privacy-row",o);a(s("accept"),'<label for="'+p+'"><input id="'+p+'" name="'+l+'" type="checkbox"><span data-on="'+s("on")+'" data-off="'+s("off")+'"></span></label>',h),void 0!==r[l].name&&a(s("name"),r[l].name,h),void 0!==r[l].provider&&a(s("provider"),r[l].provider,h),void 0!==r[l].l10n[_this.lang].description&&a(s("purpose"),r[l].l10n[_this.lang].description,h),void 0!==r[l].l10n[_this.lang].policy&&a(s("policy"),'<a href="'+r[l].l10n[_this.lang].policy+'" target="_blank">Link</a>',h)}catch(e){console.log("It is missing some properties for that service: "+l)}_this.container.appendChild(o);var v=c("privacy-footer",_this.container),u=c("privacy-link",v);u.id="privacy-reset",u.classList.add("privacy-reset"),u.innerHTML=s("reset");var f=s("legal_page");if(f&&""!=f){var m=c("privacy-link",v);m.setAttribute("href",f),m.innerHTML=s("legal_notice")}var y=s("privacy_page");if(y&&""!=y){var _=c("privacy-link",v);_.setAttribute("href",y),_.innerHTML=s("policy")}return notification.add({id:_this.options.sessionName,message:_this.container,saveState:!_this.options.force,remove:!1}),_this.elms={},_this.elms.open=i,_this.elms.submit=n,_this},a=function(e,t,i){var n=[];return n[0]=c("privacy-cell",i),n[0].innerHTML=e,n[1]=c("privacy-cell",i),n[1].innerHTML=t,n},c=function(e,t){var i=document.createElement(e);return i.classList.add(e),t&&t.appendChild(i),i},l=function(){_this.container.classList.add("open"),_this.container.parentElement.parentElement.classList.remove("hide"),document.body.classList.add("privacyControlIsOpen"),_this.elms.open.classList.add("hide")},d=function(){_this.container.classList.remove("open"),document.body.classList.remove("privacyControlIsOpen"),_this.elms.open.classList.remove("hide"),notification.close(_this.options.sessionName)},p=function(){let e=L();for(let t in e)if(!0===e[t])return!0;return!1},h=function(e){document.querySelectorAll('[data-privacy-control="'+e+'"]').forEach(function(e,t){e.classList.add("granted","activated"),e.dataset.privacyControlConsent="true"})},v=function(){document.addEventListener("click",function(e){y(!0)});for(var e=document.querySelectorAll("[data-privacy-control]:not(html)"),t=0;t<e.length;t++)e[t].addEventListener("click",function(e){e.preventDefault();var t=this.dataset.privacyControl;""==t?l():(h(t),_this.set(t,!0),_this.apply())});var i=document.querySelectorAll('[href="#privacyController"]');for(t=0;t<i.length;t++)i[t].addEventListener("click",function(e){e.preventDefault(),l()});var n=_this.container.querySelectorAll("[type=checkbox]");for(t=0;t<n.length;t++)n[t].addEventListener("change",function(e){this.checked?_this.set(this.name,!0):_this.set(this.name,!1),_this.apply()});_this.elms.submit.addEventListener("click",function(e){e.preventDefault(),_this.set("all",!0),_this.apply(),d()});var o=document.querySelectorAll(".privacy-reset");for(t=0;t<o.length;t++)o[t].addEventListener("click",function(e){_this.reset()});_this.container.parentElement.parentElement.querySelector(".close").addEventListener("click",d);var s=document.querySelectorAll(".privacy-link");for(t=0;t<s.length;t++)s[t].addEventListener("click",function(e){var t=this.getAttribute("href");null!==t&&window.open(t,"_blank").focus()});return _this},u=function(){var e=document.createElement("A");e.href="#privacyController",e.classList.add("privacyControlBadge");var t=document.createElement("SPAN");return t.innerText=s("badge"),e.appendChild(t),document.body.appendChild(e),e},f=function(){var e=_this.options.deps;for(var t in e)if("iframe"==e[t].type)for(var i=document.querySelectorAll("iframe[data-pc-service="+t+"]:not(.enabled), iframe[data-iframe="+t+"]:not(.enabled)"),n=0;n<i.length;n++){var o=i[n];o.addEventListener("load",function(){try{if(this.classList.contains("enabled"))return!1;t=this.dataset.pcService||this.dataset.iframe,doc=this.contentDocument?this.contentDocument:this.contentWindow.document,_this.frames.push(this);var i=e[t].l10n[_this.lang].policy?'<a href="'+e[t].l10n[_this.lang].policy+'" target="_blank">'+e[t].l10n[_this.lang].policy+"</a>":"";doc.body.innerHTML=doc.body.innerHTML.replaceAll("{{policy}}",i),doc.body.innerHTML=doc.body.innerHTML.replaceAll("{{name}}",e[t].name),doc.body.innerHTML=doc.body.innerHTML.replaceAll("{{activate}}",s("activate")),doc.body.innerHTML=doc.body.innerHTML.replaceAll("{{msg}}",e[t].l10n[_this.lang].description),doc.body.innerHTML=doc.body.innerHTML.replaceAll("{{provider}}",s("provider")),doc.body.innerHTML=doc.body.innerHTML.replaceAll("{{providerName}}",e[t].provider),doc.body.innerHTML=doc.body.innerHTML.replaceAll("{{key}}",t),doc.head.innerHTML=doc.head.innerHTML.replaceAll("{{key}}",t),doc.body.id=t,doc.body.classList.add("enabled"),doc.querySelector("html").lang=_this.lang,e[t].css&&(doc.head.innerHTML+='<link rel="stylesheet" href="'+e[t].css+'"></link>'),m(doc)}catch(e){console.log("Can't handle the placeholder. The service options are broken: "+t)}}),o.dataset.lang=document.querySelector("html").lang,o.src=_this.options.placeholder+"?key="+t}},m=function(e){for(var t=e.querySelectorAll(".infoOpen"),i=0,n=t.length;i<n;i++)t[i].addEventListener("click",function(e){e.preventDefault();var t=document.activeElement,i=t.contentDocument?t.contentDocument:t.contentWindow.document;i.querySelector(".infoBox").classList.add("open"),i.querySelector(".infoOpen").classList.add("hide")});var o=e.querySelectorAll(".infoClose");for(i=0,n=o.length;i<n;i++)o[i].addEventListener("click",y);e.addEventListener("keydown",function(e){27==e.keyCode&&y()}),e.querySelector(".accept").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation();var t=document.activeElement.dataset.iframe||document.activeElement.dataset.pcService;_this.set(t,!0),_this.apply()},!1)},y=function(e){var t=null===e||!1===e?[document.activeElement]:_this.frames;for(var i in t)try{doc=t[i].contentDocument?t[i].contentDocument:t[i].contentWindow.document,doc.querySelector(".infoBox").classList.remove("open"),doc.querySelector(".infoOpen").classList.remove("hide")}catch(e){}},_=function(e,t){if(!0===i[e])return!1;switch(t){case"script":try{if(void 0!==_this.options.deps[e].src){var n=_this.options.deps[e].src;"object"!=typeof n&&(n=[n]),rIt({"*":{assets:n,function:_this.options.deps[e].callback}})}else for(var o=document.querySelectorAll('script[data-script="'+e+'"], script[data-pc-service="'+e+'"]'),s=0,r=o.length;s<r;s++)s==r-1&&o[s].addEventListener("load",_this.options.deps[e].callback),o[s].src=o[s].dataset.pcAsset}catch(t){console.log("Could not load script for "+e+", no src defined.")}break;case"iframe":var a=document.querySelectorAll('[data-iframe="'+e+'"], iframe[data-pc-service="'+e+'"]');for(var s in a)if("object"==typeof a[s]&&a[s].dataset){var c=a[s].pcAsset,l=a[s].dataset.pcAsset||a[s].dataset.src;a[s].dataset.pcAsset=c,a[s].src=l,a[s].classList.add("enabled","pcLoaded"),a[s].classList.remove("pcUnloaded"),a[s].dataset.frameId=(new Date).getTime()}break;case"image":let i=document.querySelectorAll('img[data-pc-service="'+e+'"]');for(let e of i){let t=e.src;e.src=e.dataset.pcAsset,e.dataset.pcAsset=t,e.classList.add("pcLoaded"),e.classList.remove("pcUnloaded")}}return i[e]=!0,h(e),!0},g=function(e,t){if(!1===i[e])return!1;switch(t){case"iframe":var n=document.querySelectorAll('[data-iframe="'+e+'"], iframe[data-pc-service="'+e+'"]');for(var o in n)if("object"==typeof n[o]&&n[o].dataset){var s=n[o].dataset.src,r=n[o].src;n[o].classList.remove("enabled","pcLoaded"),n[o].classList.add("pcUnloaded"),n[o].dataset.pcAsset=r,n[o].src=s,f()}break;case"image":let i=document.querySelectorAll('img[data-pc-service="'+e+'"]');for(let e of i){let t=e.src;e.src=e.dataset.pcAsset,e.dataset.pcAsset=t,e.classList.remove("pcLoaded"),e.classList.add("pcUnloaded")}}return i[e]=!1,!0},L=function(){var e=_this.storage.getItem(_this.options.sessionName);return e=null===e||""===e||!1===e?{}:JSON.parse(e)};return _this.apply=function(){var e=_this.get("all");for(var t in e)if(void 0!==_this.options.deps[t]){var n=_this.options.deps[t].type;void 0===_this.options.deps[t]||!1===e[t]?void 0!==t&&!0===i[t]&&g(t,n):void 0!==t&&_(t,n)}return function(){for(var e in _this.options.deps){_this.options.deps[e];var t=_this.get(e);void 0===t&&(t=!1,_this.set(e,t));var i=_this.options.sessionName+":"+e;document.getElementById(i).checked=t}_this}(),_this},_this.set=function(e,t){var i=L();if("all"===e)for(var n in i)_this.set(n,t);else{i[e]=t;try{if(_this.storage.setItem(_this.options.sessionName,JSON.stringify(i)),!_this.options.deps[e])throw new Error("Key "+e+" is missing in the PrivacyControl deps configuration object.");void 0!==_this.options.deps[e].forceReload&&!0===_this.options.deps[e].forceReload&&"complete"===document.readyState&&window.location.reload()}catch(e){console.error(e)}}return i},_this.get=function(e){var t=L();return"all"==e?t:t[e]},_this.reset=function(){return _this.storage.setItem(_this.options.sessionName,"{}"),_this.storage.removeItem("note-"+_this.options.sessionName),location.reload(),_this.get("all")},_this.please=function(){return _this.set("all",!0),console.info("%c Hello my dear, I appreciate that you ask me to enable all services now and you're welcome. But keep in mind, you should not!","background: #222; color: #bada55"),_this.apply(),"This is a shortcut for set('all', true) and apply()"},_this.options.badge&&u(),o(),r(),_this.apply(),f(),v(),!1!==_this.options.force&&!0!==p()||_this.container.parentElement.parentElement.classList.add("hide"),_this}void 0===String.prototype.replaceAll&&(String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"g"),t)});